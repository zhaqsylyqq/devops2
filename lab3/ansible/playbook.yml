- hosts: kubelet
  become: yes

  tasks:

    - name: Disable swap
      command: swapoff -a

    - name: Install containerd
      apt:
        name: containerd
        state: present
        update_cache: yes

    - name: Ensure /etc/containerd exists
      file:
        path: /etc/containerd
        state: directory


    - name: Generate containerd config
      command: containerd config default
      register: containerd_config

    - name: Write containerd config
      copy:
        content: "{{ containerd_config.stdout }}"
        dest: /etc/containerd/config.toml

    - name: Enable SystemdCgroup
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'

    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted
        enabled: yes

    - name: Install required packages for Kubernetes repo
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gpg
        state: present
        update_cache: yes

    - name: Ensure keyrings directory exists
      file:
        path: /etc/apt/keyrings
        state: directory

    - name: Add Kubernetes GPG key
      shell: >
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key |
        gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Add Kubernetes apt repository
      copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /

    - name: Update apt cache after adding Kubernetes repo
      apt:
        update_cache: yes


    - name: Install kubelet and cri-tools
      apt:
        name:
          - kubelet
          - cri-tools
        state: present

    - name: Create required directories
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - /var/lib/kubelet
        - /etc/kubernetes/manifests
        - /etc/cni/net.d

    - name: Deploy kubelet config
      template:
        src: kubelet-config.yaml.j2
        dest: /var/lib/kubelet/config.yaml

    - name: Ensure kubelet systemd override directory exists
      file:
        path: /etc/systemd/system/kubelet.service.d
        state: directory

    - name: Configure kubelet systemd override
      copy:
        dest: /etc/systemd/system/kubelet.service.d/override.conf
        content: |
          [Service]
          ExecStart=
          ExecStart=/usr/bin/kubelet --config=/var/lib/kubelet/config.yaml --container-runtime-endpoint=unix:///run/containerd/containerd.sock

    - name: Reload systemd
      command: systemctl daemon-reload

    - name: Restart kubelet
      systemd:
        name: kubelet
        state: restarted
        enabled: yes

    - name: Deploy CNI config
      template:
        src: cni.conf.j2
        dest: /etc/cni/net.d/10-bridge.conf

    - name: Deploy static pod
      template:
        src: static-pod.yaml.j2
        dest: /etc/kubernetes/manifests/app-with-db.yaml

    - name: Restart kubelet
      systemd:
        name: kubelet
        state: restarted
        enabled: yes
